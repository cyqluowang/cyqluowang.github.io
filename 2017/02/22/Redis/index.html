<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>Redis | 无醉</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis</h1><a id="logo" href="/">无醉</a><p class="description">所过之处皆成岚</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Redis</h1><div class="post-meta">2017-02-22 | </div><span data-thread-key="2017/02/22/Redis/" class="ds-thread-count"></span><div class="post-content"><p>1、添加依赖配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>2、编写配置文件,设置redis的一些配置<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableCaching</span><span class="comment">//重要  不能忘记， 不然@Cacheable无效</span></div><div class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:config/redis.properties"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span>  <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span></span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> Environment env;<span class="comment">//读取redis.properties中设置的变量</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="keyword">public</span> <span class="function">RedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">        JedisConnectionFactory jedisConnectionFactory = <span class="keyword">new</span> JedisConnectionFactory();<span class="comment">//连接配置</span></div><div class="line">        jedisConnectionFactory.setHostName(env.getProperty(<span class="string">"redis.host"</span>).trim());<span class="comment">//主机</span></div><div class="line">        jedisConnectionFactory.setPort(Integer.parseInt(env.getProperty(<span class="string">"redis.port"</span>).trim()));<span class="comment">//端口</span></div><div class="line">        jedisConnectionFactory.setPassword(env.getProperty(<span class="string">"redis.password"</span>).trim());<span class="comment">//密码</span></div><div class="line">        jedisConnectionFactory.setUsePool(<span class="keyword">true</span>);<span class="comment">//使用池</span></div><div class="line">        jedisConnectionFactory.setPoolConfig(jedisPoolConfig);</div><div class="line">        <span class="keyword">return</span> jedisConnectionFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 重写生成key的策略</div><div class="line">     * 包名+类名+方法名+参数</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="keyword">public</span> <span class="function">KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function">Object <span class="title">generate</span><span class="params">(Object <span class="keyword">target</span>, Method method, Object... params)</span> </span>&#123;</div><div class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">                sb.append(<span class="keyword">target</span>.getClass().getName());</div><div class="line">                sb.append(method.getName());</div><div class="line">                <span class="keyword">for</span> (Object obj : params) &#123;</div><div class="line">                    sb.append(obj.toString());</div><div class="line">                &#125;</div><div class="line">                <span class="function"><span class="keyword">return</span> sb.<span class="title">toString</span><span class="params">()</span></span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 管理缓存</div><div class="line">     * values 缓存存储的集合名  就是这个值存在哪里</div><div class="line">     * 设置了value  在使用后就会同步过期时间。</div><div class="line">     * 否则采用默认过期时间</div><div class="line">     * <span class="doctag">@param</span> redisTemplate</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="keyword">public</span> <span class="function">CacheManager <span class="title">cacheManager</span><span class="params">(RedisTemplate redisTemplate)</span> </span>&#123;</div><div class="line">        RedisCacheManager rcm = <span class="keyword">new</span> RedisCacheManager(redisTemplate);</div><div class="line">        <span class="comment">//设置缓存过期时间</span></div><div class="line">         rcm.setDefaultExpiration(<span class="number">6000</span>);<span class="comment">//秒</span></div><div class="line">        <span class="comment">//设置value的过期时间</span></div><div class="line">        Map&lt;String,Long&gt; map=<span class="keyword">new</span> HashMap();</div><div class="line">        map.put(<span class="string">"valuetest"</span>,<span class="number">6</span>L);</div><div class="line">        rcm.setExpires(map);</div><div class="line">        <span class="keyword">return</span> rcm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * RedisTemplate配置</div><div class="line">     * <span class="doctag">@param</span> factory</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, String&gt; redisTemplate(RedisConnectionFactory factory) &#123;</div><div class="line">        StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate(factory);</div><div class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</div><div class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</div><div class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</div><div class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</div><div class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</div><div class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</div><div class="line">        template.afterPropertiesSet();</div><div class="line">        <span class="keyword">return</span> template;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3、使用，方式一（代码使用）<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@Repository</div><div class="line"><span class="keyword">public</span> class RedisBaseDao &#123;</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    RedisTemplate redisTemplate;<span class="comment">//设置过期时间，如果不需要不用注入</span></div><div class="line"></div><div class="line">    <span class="comment">//实例化ValueOperations时需要名为redisTemplate的实例，这里根据名称注入，byName</span></div><div class="line">    @Resource(name=<span class="string">"redisTemplate"</span>)</div><div class="line">    <span class="keyword">protected</span> ValueOperations&lt;Serializable, <span class="keyword">Object</span>&gt; valueOperations;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//设置，缓存</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> addValue(<span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">Object</span> value)&#123;</div><div class="line">        valueOperations.<span class="built_in">set</span>(<span class="built_in">key</span>, value);</div><div class="line">        <span class="comment">//设置过期时间</span></div><div class="line">        redisTemplate.expire(<span class="built_in">key</span>,<span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//缓存取值</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">Object</span> getValue(<span class="keyword">String</span> <span class="built_in">key</span>)&#123;</div><div class="line">        <span class="keyword">return</span> valueOperations.<span class="built_in">get</span>(<span class="built_in">key</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>4、使用方式二（注解使用）<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Cacheable(value =<span class="meta-string">"valuetest"</span>)</span></div><div class="line">    <span class="keyword">public</span> String getCacheableTest(String i)&#123;</div><div class="line">        System.<span class="keyword">out</span>.println(<span class="string">"运行么？。。。。。。。"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"我是缓存的测试，不知道成功不成功"</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="注解说明"><a href="#注解说明" class="headerlink" title="注解说明"></a>注解说明</h2><p>1、同一个类中调用不会有缓存的效果，要不同的类<br>2、自动会取，设置值。<br>3、 value、cacheNames：两个等同的参数（cacheNames为Spring 4新增，作为value的别名），用于指定缓存存储的集合名。由于Spring 4中新增了@CacheConfig，因此在Spring 3中原本必须有的value属性，也成为非必需项了<br> 4、 key：缓存对象存储在Map集合中的key值，非必需，缺省按照函数的所有参数组合作为key值，若自己配置需使用SpEL表达式，比如：@Cacheable(key = “#p0”)：使用函数第一个参数作为缓存的key值，更多关于SpEL表达式的详细内容可参考官方文档</p>
<p>5、 @CacheConfig：主要用于配置该类中会用到的一些共用的缓存配置。在这里@CacheConfig(cacheNames = “users”)：配置了该数据访问对象中返回的内容将存储于名为users的缓存对象中，我们也可以不使用该注解，直接通过@Cacheable自己配置缓存集的名字来定义。</p>
<p>6、 @Cacheable：配置了findByName函数的返回值将被加入缓存。同时在查询时，会先从缓存中获取，若不存在才再发起对数据库的访问。该注解主要有下面几个参数：</p>
<p>  7、 condition：缓存对象的条件，非必需，也需使用SpEL表达式，只有满足表达式条件的内容才会被缓存，比如：@Cacheable(key = “#p0”, condition = “#p0.length() &lt; 3”)，表示只有当第一个参数的长度小于3的时候才会被缓存，若做此配置上面的AAA用户就不会被缓存，读者可自行实验尝试。<br> 8、 unless：另外一个缓存条件参数，非必需，需使用SpEL表达式。它不同于condition参数的地方在于它的判断时机，该条件是在函数被调用之后才做判断的，所以它可以通过对result进行判断。<br>9、 keyGenerator：用于指定key生成器，非必需。若需要指定一个自定义的key生成器，我们需要去实现org.springframework.cache.interceptor.KeyGenerator接口，并使用该参数来指定。需要注意的是：该参数与key是互斥的</p>
<p>10、 cacheManager：用于指定使用哪个缓存管理器，非必需。只有当有多个时才需要使用<br> 11、 cacheResolver：用于指定使用那个缓存解析器，非必需。需通过org.springframework.cache.interceptor.CacheResolver接口来实现自己的缓存解析器，并用该参数指定。</p>
<p>除了这里用到的两个注解之外，还有下面几个核心注解：</p>
<ul>
<li>@CachePut：配置于函数上，能够根据参数定义条件来进行缓存，它与@Cacheable不同的是，它每次都会真是调用函数，所以主要用于数据新增和修改操作上。它的参数与@Cacheable类似，具体功能可参考上面对@Cacheable参数的解析</li>
<li><p>@CacheEvict：配置于函数上，通常用在删除方法上，用来从缓存中移除相应数据。除了同@Cacheable一样的参数之外，它还有下面两个参数：</p>
<ul>
<li>allEntries：非必需，默认为false。当为true时，会移除所有数据</li>
<li>beforeInvocation：非必需，默认为false，会在调用方法之后移除数据。当为true时，会在调用方法之前移除数据。</li>
</ul>
</li>
</ul>
</div><div class="tags"><a href="/tags/spring/">spring</a></div><div class="post-nav"><a href="/2017/02/27/自定义控件/" class="pre"><i class="icon-previous">自定义控件</i></a><a href="/2017/02/22/Druid/" class="next">Druid<i class="icon-next"></i></a></div><div data-thread-key="2017/02/22/Redis/" data-title="Redis" data-url="http://cyqluowang.github.io/2017/02/22/Redis/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2017/02/22/Redis/" data-title="Redis" data-url="http://cyqluowang.github.io/2017/02/22/Redis/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="si" value="http://cyqluowang.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title">分类</div></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/总结/" style="font-size: 15px;">总结</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/IOS/" style="font-size: 15px;">IOS</a> <a href="/tags/管理学/" style="font-size: 15px;">管理学</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/技巧/" style="font-size: 15px;">技巧</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/汽车/" style="font-size: 15px;">汽车</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/05/10/wedding/wedding/">wedding/wedding</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/10/wedding/README/">wedding/README</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/10/wedding/index/">wedding/index</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/21/password/">password</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/08/AIDL/">AIDL</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/27/自定义控件/">自定义控件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/Redis/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/Druid/">Druid</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/Mybatis/">Mybatis</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/热部署/">热部署</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://www.19lou.com/" title="19lou" target="_blank">19lou</a><ul></ul><a href="http://www.renrunkeji.com/" title="仁润科技" target="_blank">仁润科技</a><ul></ul><a href="https://www.haomwei.com/technology/maupassant-hexo.html" title="maupassant使用" target="_blank">maupassant使用</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">无醉.</a> QQ:573700261.</div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js"></script>
<script src="/js/totop.js"></script><script src="/js/fancybox.pack.js"></script>
<script src="/js/jquery.fancybox.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"><script>var duoshuoQuery = {short_name:'cyqluowang'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></body></html>